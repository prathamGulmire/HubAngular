<h2>Student/User List</h2>

<dx-data-grid
  #datagrid
  class="dx-card content-block"
  [dataSource]="dataSource"
  [keyExpr]="'id'"
  [showBorders]="false"
  [focusedRowEnabled]="true"
  [focusedRowIndex]="0"
  [columnAutoWidth]="true"
  [columnHidingEnabled]="true"
  [allowColumnReordering]="true"
  (onRowInserting)="insertRow($event)"
  (onRowRemoving)="removeRow($event)"
  (onRowUpdating)="updateRow($event)"
  (onEditingStart)="onEdit($event)"
  (onInitNewRow)="initNewRow($event)"
  (onRowValidating)="onRowValidating($event)"
  (onEditCanceling)="onEditCanceling($event)"
  (onSaving)="onSaving($event)"
  (onExporting)="onExporting($event)">

  <dxo-data-grid-paging [pageSize]="10"></dxo-data-grid-paging>
  <dxo-data-grid-pager [showPageSizeSelector]="true" [showInfo]="true"></dxo-data-grid-pager>
  <dxo-data-grid-filter-row [visible]="true"></dxo-data-grid-filter-row>

  <dxo-data-grid-selection mode="multiple"></dxo-data-grid-selection>

  <dxo-data-grid-export
    [enabled]="true"
    [formats]="['pdf','excel']"
    [allowExportSelectedData]="true"
  ></dxo-data-grid-export>

  <dxo-data-grid-editing 
    mode="form"
    [allowUpdating]="true"
    [allowDeleting]="true"
    [allowAdding]="true"
    [confirmDelete]="false"
    >
      <dxo-form
        [colCountByScreen]="{
            xs: 1,
            sm: 2,
            md: 2,
            lg: 3
        }">

        <dxi-item 
          dataField="firstName" 
          editorType="dxTextBox"
          caption="First Name"
          [editorOptions]="{
            placeholder: 'Enter first name'
          }">
          <dxi-validation-rule type="required" message="First name is required"></dxi-validation-rule>
        </dxi-item>

        <dxi-item 
          dataField="lastName" 
          caption="Last Name"
          [editorOptions]="{
            placeholder: 'Enter Last Name'
          }">
          <dxi-validation-rule type="required" message="Last name is required"></dxi-validation-rule>
        </dxi-item>

        <dxi-item 
        dataField="middleName" 
        caption="Middle Name"
        [editorOptions]="{
          placeholder: 'Enter Middle Name'
        }">
          <!-- <dxi-validation-rule type="required" message="Last name is required"></dxi-validation-rule> -->
        </dxi-item>

        <dxi-item
          class="img-container"
          itemType="simple"
          [label]="{ text: 'Profile Image' }">

          <ng-container *ngIf="showUploader && imagePreviewUrl == null">
            <dx-file-uploader
              accept="image/*"
              [multiple]="false"
              uploadMode="useForm"
              (onValueChanged)="onImageSelected($event)">
            </dx-file-uploader>
          </ng-container>

          <img
            *ngIf="imagePreviewUrl"
            [src]="imagePreviewUrl"
            class="profile-img"/>

          <dx-button
            *ngIf="!showUploader && imagePreviewUrl != null"
            icon="trash"
            type="danger"
            stylingMode="outlined"
            (onClick)="removeImage()">
          </dx-button>

          <div class="dx-invalid-message" *ngIf="profileImageError">
            {{ profileImageErrorMessage }}
          </div>
        </dxi-item>

        <dxi-item
          dataField="email"
          editorType="dxTextBox"
          [editorOptions]="{
            mode: 'email',
            placeholder: 'Enter email'
          }">
          <dxi-validation-rule type="required" message="Email is required"></dxi-validation-rule>
          <dxi-validation-rule type="email" message="Invalid email"></dxi-validation-rule>
        </dxi-item>

        <dxi-item
          dataField="departmentId"
          editorType="dxSelectBox"
          [editorOptions]="{
            dataSource: departments,
            displayExpr: 'departmentName',
            valueExpr: 'departmentId',
            placeholder: 'Select Department'
          }">
          <dxi-validation-rule
            type="required"
            message="Department is required">
          </dxi-validation-rule>
        </dxi-item>

        <dxi-item
          dataField="gender"
          editorType="dxSelectBox"
          [editorOptions]="{
            items: genders,
            placeholder: 'Select gender'
          }">
          <dxi-validation-rule type="required" message="Gender is required"></dxi-validation-rule>
        </dxi-item>

        <dxi-item
          dataField="dateOfBirth"
          editorType="dxDateBox"
          [editorOptions]="{
            type: 'date',
            displayFormat: 'dd/MM/yyyy',
            dateSerializationFormat: 'yyyy-MM-dd'
          }">
          <dxi-validation-rule type="required" message="Date of birth is required"></dxi-validation-rule>
        </dxi-item>

        <dxi-item
          dataField="address"
          editorType="dxTextArea"
          [editorOptions]="{
            placeholder: 'Enter address',
            height: 80
          }">
          <dxi-validation-rule type="required" message="Address is required"></dxi-validation-rule>
        </dxi-item>

        <dxi-item
          dataField="country"
          editorType="dxTextBox"
          [editorOptions]="{ placeholder: 'Enter country' }">
          <dxi-validation-rule type="required" message="Country is required"></dxi-validation-rule>
        </dxi-item>
      
        <dxi-item
          dataField="state"
          editorType="dxTextBox"
          [editorOptions]="{ placeholder: 'Enter state' }">
          <dxi-validation-rule type="required" message="State is required"></dxi-validation-rule>
        </dxi-item>

        <dxi-item
          dataField="password"
          editorType="dxTextBox"
          [editorOptions]="{
            placeholder: 'Enter password'
          }">
          <dxi-validation-rule type="required" message="Password is required"></dxi-validation-rule>
          <dxi-validation-rule type="stringLength"
              [min]="6"
              message="Password must be at least 6 characters">
          </dxi-validation-rule>
        </dxi-item>

        <dxi-item
          dataField="pincode"
          editorType="dxTextBox"
          [editorOptions]="{
            mode: 'number',
            placeholder: 'Enter pincode'
          }">
          <dxi-validation-rule type="required" message="Pincode is required"></dxi-validation-rule>
          <dxi-validation-rule
            type="pattern"
            pattern="^\d{6}$"
            message="Pincode must be 6 digits">
          </dxi-validation-rule>
        </dxi-item>
      </dxo-form>
  </dxo-data-grid-editing>

  <dxi-data-grid-column
    dataField="id"
    [width]="70"
    [hidingPriority]="2">
  </dxi-data-grid-column>

  <dxi-data-grid-column
    dataField="firstName"
    caption="First Name"
    [hidingPriority]="8">
  </dxi-data-grid-column>

  <dxi-data-grid-column
    dataField="lastName"
    caption="Last Name"
    [hidingPriority]="5">
  </dxi-data-grid-column>
  
  <dxi-data-grid-column
    dataField="email"
    caption="Email"
    [hidingPriority]="5">
  </dxi-data-grid-column>

  <dxi-data-grid-column
    dataField="gender"
    caption="Gender"
    [allowSorting]="false"
    [hidingPriority]="4">
  </dxi-data-grid-column>
  
  <dxi-data-grid-column
    dataField="address"
    caption="Address"
    [allowExporting]="false"
    [hidingPriority]="2"
    [visible]="false">
  </dxi-data-grid-column>

  <dxi-data-grid-column
    dataField="country"
    caption="Country"
    [allowExporting]="false"
    [hidingPriority]="3">
  </dxi-data-grid-column>

  <dxi-data-grid-column dataField="middleName" [visible]="false"></dxi-data-grid-column>
  <dxi-data-grid-column dataField="state" [visible]="false"></dxi-data-grid-column>
  <dxi-data-grid-column dataField="pincode" [visible]="false"></dxi-data-grid-column>
  <dxi-data-grid-column dataField="password" [visible]="false"></dxi-data-grid-column>
  <dxi-data-grid-column dataField="dateOfBirth" [visible]="false"></dxi-data-grid-column>
  <dxi-data-grid-column dataField="imageUrl" [visible]="false"></dxi-data-grid-column>

  <dxi-data-grid-column 
    dataField="departmentId"
    caption="Department"
    [visible]="true"
    [hidingPriority]="7">
    <dxo-lookup
      [dataSource]="departments"
      valueExpr="departmentId"
      displayExpr="departmentName">
    </dxo-lookup>
  </dxi-data-grid-column>

  <dxi-data-grid-column
    dataField="createdAt"
    caption="Created At"
    [allowExporting]="false"
    [hidingPriority]="1">
  </dxi-data-grid-column>

  <dxo-data-grid-search-panel [visible]="true"></dxo-data-grid-search-panel>
  <dxo-data-grid-group-panel [visible]="true"></dxo-data-grid-group-panel>
</dx-data-grid>

<dx-popup
  [visible]="false"
  title="Edit/Delete student"
  [width]="'80%'"
  [height]="600"
  [showCloseButton]="true"
  [dragEnabled]="true"
  [resizeEnabled]="true">

  <div class="popup-container">

    <div class="popup-body">
      <dx-form
        id="userForm"
        #myForm
        [formData]=""
        labelLocation="top"
        [colCountByScreen]="{
          xs: 1,
          sm: 2,
          md: 2,
          lg: 3
        }"
      >

      <dxi-item
        dataField="firstName"
        editorType="dxTextBox"
        [editorOptions]="{ placeholder: 'Enter first name' }">
        <dxi-validation-rule type="required" message="First name is required"></dxi-validation-rule> 
      </dxi-item>

      <dxi-item
        dataField="middleName"
        editorType="dxTextBox"
        [editorOptions]="{ placeholder: 'Enter middle name' }">
      </dxi-item>

      <dxi-item
        dataField="lastName"
        editorType="dxTextBox"
        [editorOptions]="{ placeholder: 'Enter last name' }">
        <dxi-validation-rule type="required" message="Last name is required"></dxi-validation-rule>
      </dxi-item>

      <dxi-item
        dataField="email"
        editorType="dxTextBox"
        [editorOptions]="{
          mode: 'email',
          placeholder: 'Enter email'
        }">
        <dxi-validation-rule type="required" message="Email is required"></dxi-validation-rule>
        <dxi-validation-rule type="email" message="Invalid email"></dxi-validation-rule>
      </dxi-item>

      <dxi-item
        dataField="gender"
        editorType="dxSelectBox"
        [editorOptions]="{
          items: genders,
          placeholder: 'Select gender'
        }">
        <dxi-validation-rule type="required" message="Gender is required"></dxi-validation-rule>
      </dxi-item>

      <dxi-item
        dataField="dateOfBirth"
        editorType="dxDateBox"
        [editorOptions]="{
          type: 'date',
          displayFormat: 'dd/MM/yyyy'
        }">
        <dxi-validation-rule type="required" message="Date of birth is required"></dxi-validation-rule>
      </dxi-item>

      <dxi-item
        dataField="address"
        editorType="dxTextArea"
        [editorOptions]="{
          placeholder: 'Enter address',
          height: 80
        }">
        <dxi-validation-rule type="required" message="Address is required"></dxi-validation-rule>
      </dxi-item>

      <dxi-item
        dataField="country"
        editorType="dxTextBox"
        [editorOptions]="{ placeholder: 'Enter country' }">
        <dxi-validation-rule type="required" message="Country is required"></dxi-validation-rule>
      </dxi-item>
    >
      <dxi-item
        dataField="state"
        editorType="dxTextBox"
        [editorOptions]="{ placeholder: 'Enter state' }">
        <dxi-validation-rule type="required" message="State is required"></dxi-validation-rule>
      </dxi-item>

      <dxi-item
        itemType="simple"
        label="{ text: 'Profile Image' }">

        <dx-file-uploader
          accept="image/*"
          [multiple]="false"
          uploadMode="useForm"
          (onValueChanged)="onImageSelected($event)">
        </dx-file-uploader>

        <div class="dx-invalid-message" *ngIf="profileImageError">
          {{ profileImageErrorMessage }}
        </div>
      </dxi-item>

      <dxi-item
        dataField="password"
        editorType="dxTextBox"
        [editorOptions]="{
          placeholder: 'Enter password'
        }">
        <dxi-validation-rule type="required" message="Password is required"></dxi-validation-rule>
        <dxi-validation-rule type="stringLength"
            [min]="6"
            message="Password must be at least 6 characters">
        </dxi-validation-rule>
      </dxi-item>

      <dxi-item
        dataField="pincode"
        editorType="dxTextBox"
        [editorOptions]="{
          mode: 'number',
          placeholder: 'Enter pincode'
        }">
        <dxi-validation-rule type="required" message="Pincode is required"></dxi-validation-rule>
        <dxi-validation-rule
          type="pattern"
          pattern="^\d{6}$"
          message="Pincode must be 6 digits">
        </dxi-validation-rule>
      </dxi-item>

      </dx-form>
    </div>  

    <div class="form-actions">

      <dx-button
        text="Update"
        type="success"
        width="120"
        (onClick)="updateUser({})">
      </dx-button>

      <dx-button
        text="Delete"
        type="danger"
        width="120"
        (onClick)="deleteUser(0)"
        class="delete-btn">
      </dx-button>
      
      <dx-button
        text="Cancel"
        type="normal"
        width="120"
        (onClick)="onCancel()">
      </dx-button>

    </div>
  </div>
</dx-popup>